import{L as R,j as i,K,u as N,k as e}from"./index-d15f3e7a.js";import{u as d,al as k,a6 as m,a7 as z,a2 as G,I as O,L as g,af as M,ag as T,ah as L,a8 as j,a9 as v,aa as f,am as V,an as W,B as y,ao as J,ap as X,aq as Y,ar as Z,as as ee,at as se,au as ae,ab as w,S as te,ad as ne,Q,ac as re}from"./App-cb5da2f9.js";function ie(){const{toast:t}=R(),{conversationID:l}=d(),{socket:o}=i.useContext(K),u=N();return k({mutationFn:async({content:n,receiverName:c})=>await m.post(`/api/users/current-user/conversations/send-message/${l}`,{content:n,receiverName:c}),onSuccess(n){o==null||o.emit("chat-message",n.data),u.invalidateQueries({queryKey:["conversations"]}),u.invalidateQueries({queryKey:["conversation",l]})},onError(n){t({title:"Oops! Message not sent.",description:n.response.data.error,variant:"destructive"})}})}function oe(){const{conversationId:t}=d(),l=N();return k({mutationFn:async o=>await m.delete(`/api/users/current-user/conversations/delete/${o}`),onSuccess:()=>{l.removeQueries({queryKey:["conversation",t]})}})}function le(){const{conversationID:t}=d();return z({queryKey:["conversation",t],queryFn:async()=>await m.get(`/api/users/current-user/conversations/${t}`),enabled:t!=null})}function de(){var C,D,A,q,F,S,I;const{conversationID:t}=d(),l=G(),o=ie(),{mutate:u}=oe(),n=N(),{socket:c}=i.useContext(K),{data:s,isPending:_}=le(),[$,P]=i.useState([]),[r,E]=i.useState([]),[x,b]=i.useState(""),[h,U]=i.useState();i.useEffect(()=>{var a;s!=null&&s.data.conversation.length&&((a=s==null?void 0:s.data.conversation)==null||a.map(p=>E(p.participants.filter(H=>H._id!==s.data.currentUserID)))),U(s==null?void 0:s.data.conversation),s==null||s.data.conversation.map(p=>P(p.messages))},[s==null?void 0:s.data.conversation,s==null?void 0:s.data.currentUserID]);async function B(a){await m.patch(`/api/users/current-user/conversations/read-message/${a}`,{read:!0}),n.invalidateQueries({queryKey:["conversations"]}),n.invalidateQueries({queryKey:["guest-notifications"]})}return i.useEffect(()=>{c==null||c.on("receive-message",()=>{n.invalidateQueries({queryKey:["conversation",t]}),n.invalidateQueries({queryKey:["conversations"]})})},[t,n,c]),e.jsx("div",{className:"px-8 py-6",children:_?e.jsx(O,{}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 flex w-full items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{to:`/users/visit/show/${(C=r[0])==null?void 0:C._id}`,children:e.jsxs(M,{children:[e.jsx(T,{className:"object-cover",src:(D=r[0])==null?void 0:D.photoUrl}),e.jsx(L,{children:"CN"})]})}),e.jsx("span",{className:"text-lg font-semibold",children:(A=r[0])==null?void 0:A.username})]}),e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(f,{children:e.jsxs(V,{children:[e.jsx(W,{asChild:!0,children:e.jsx(y,{className:"p-2",variant:"destructive",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"white",className:"h-6 w-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"})})})}),e.jsxs(J,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Are you absolutely sure?"}),e.jsxs(Z,{className:"font-semibold text-gray-600",children:["This action cannot be undone. This will"," ",e.jsx("span",{className:"font-bold text-red-600 underline",children:"permanently delete"})," ","this conversation from our servers."]})]}),e.jsxs(ee,{children:[e.jsx(se,{className:"rounded-full",children:"Cancel"}),e.jsx(ae,{onClick:()=>{t&&u(t),setTimeout(()=>{l("/messages",{replace:!0}),document.location.reload()},600)},className:"rounded-full bg-gray-950",children:"Continue"})]})]})]})}),e.jsx(w,{children:e.jsx("p",{children:"Delete chat"})})]})})]}),e.jsx(te,{}),e.jsxs(ne,{className:"relative mt-2 h-[65vh] rounded-md border bg-[#F5F5F5] p-6",children:[e.jsxs("div",{className:"mx-auto flex w-max flex-col items-center justify-center gap-2",children:[e.jsx(g,{to:`/users/visit/show/${(q=r[0])==null?void 0:q._id}`,children:e.jsxs(M,{className:"h-24 w-24",children:[e.jsx(T,{className:"object-cover",src:(F=r[0])==null?void 0:F.photoUrl}),e.jsx(L,{children:"CN"})]})}),e.jsx("span",{className:"text-xl font-semibold",children:(S=r[0])==null?void 0:S.username}),e.jsx(g,{to:`/users/visit/show/${(I=r[0])==null?void 0:I._id}`,children:e.jsx(y,{className:"rounded-full bg-zinc-900 text-xs",children:"View profile"})})]}),e.jsx("div",{className:"mb-10 mt-4 flex h-max flex-col gap-2 p-4",children:$.map(a=>a.senderID._id===(s==null?void 0:s.data.currentUserID)?e.jsx(j,{children:e.jsxs(v,{children:[e.jsxs(f,{className:"ml-auto w-max rounded-full bg-gray-900 px-4 py-2",children:[" ",e.jsx("span",{className:"text-sm font-medium text-white",children:a.content},a._id)]}),e.jsx(w,{children:e.jsx("p",{children:Q(new Date(a.createdAt),"p")})})]})}):e.jsx(j,{children:e.jsxs(v,{children:[e.jsxs(f,{className:"mr-auto w-max rounded-full bg-gray-700 px-4 py-2",children:[" ",e.jsx("span",{className:"text-sm font-medium text-white",children:a.content},a._id)]}),e.jsx(w,{children:e.jsx("p",{children:Q(new Date(a.createdAt),"p")})})]})}))}),e.jsx("form",{onSubmit:a=>{a.preventDefault(),b(""),o.mutate({content:x,receiverName:r[0].username})},children:e.jsxs("div",{className:"absolute bottom-0 left-0 flex w-full items-center justify-between gap-2 bg-[#F5F5F5] p-2",children:[e.jsx(re,{value:x,onChange:a=>b(a.target.value),placeholder:"Message...",onFocus:async()=>{var a;return h!=null&&!((a=h[0])!=null&&a.lastMessage.read)&&await B(h[0].lastMessage._id)},className:"w-full rounded-full bg-white p-5 font-medium",spellCheck:"true"}),e.jsx(y,{disabled:!x,className:"rounded-full bg-gray-950 p-6 text-lg",children:"Send"})]})})]})]})})}export{de as default};
